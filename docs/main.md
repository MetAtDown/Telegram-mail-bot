# Система пересылки Email в Telegram - Техническая документация
## Оглавление

1. [**Обзор системы**](#1-обзор-системы)
2. [**Архитектура**](#2-архитектура)
3. [**Установка и настройка**](#3-установка-и-настройка)
4. [**Структура базы данных**](#4-структура-базы-данных)
5. [**Модули и компоненты**](#5-модули-и-компоненты)
6. [**API и точки интеграции**](#6-api-и-точки-интеграции)
7. [**Интерфейс администратора**](#7-интерфейс-администратора)
8. [**Использование CLI**](#8-использование-cli)
9. [**Обработка ошибок и ведение журнала**](#9-обработка-ошибок-и-ведение-журнала) 
10. [**Вопросы безопасности**](#10-вопросы-безопасности)
11. [**Устранение неполадок**](#11-устранение-неполадок)
12. [**FAQ**](#12-faq)
13. [**Расширенная настройка**](#13-расширенная-настройка)
14. [**Разработка и расширение**](#14-разработка-и-расширение)


## 1. Обзор системы

Система пересылки Email в Telegram представляет собой модульное приложение, предназначенное для мониторинга входящих электронных писем и их пересылки определенным пользователям Telegram на основе настраиваемых фильтров темы письма. Система предоставляет веб-интерфейс администратора для конфигурации и CLI-инструмент для управления и диагностики.

### Основные возможности
- Автоматический мониторинг электронной почты с IMAP-серверов (преимущественно Яндекс)
- Настраиваемая фильтрация писем по теме
- Поддержка нескольких пользователей с индивидуальными настройками подписки
- Веб-интерфейс администратора для управления пользователями и темами
- Telegram-бот для взаимодействия с пользователями и настройки
- CLI-инструмент для управления системой и диагностики
- Надежная обработка ошибок и ведение журналов
- Управление кэшированием для оптимизации производительности

### Технологический стек
- **Бэкенд**: Python 3.x
- **Веб-интерфейс**: Flask
- **База данных**: SQLite с режимом WAL
- **Электронная почта**: IMAP через imaplib
- **Обмен сообщениями**: Telegram Bot API через pyTelegramBotAPI
- **Управление процессами**: Встроенный мониторинг и восстановление процессов

## 2. Архитектура

Система следует модульной архитектуре со следующими основными компонентами:

### Основные компоненты
1. **Системный контроллер** (`system.py`): Координирует все компоненты системы и управляет жизненным циклом процессов
2. **Обработчик электронной почты** (`email_handler.py`): Мониторит почтовые аккаунты и обрабатывает электронные письма
3. **Обработчик Telegram** (`telegram_handler.py`): Управляет интерфейсом Telegram-бота и доставкой сообщений
4. **Менеджер базы данных** (`manager.py`): Предоставляет доступ к базе данных и управление транзакциями
5. **Интерфейс администратора** (`admin.py`): Веб-интерфейс для администрирования системы
6. **CLI-инструмент** (`tools.py`): Интерфейс командной строки для управления системой

### Диаграмма взаимодействия компонентов
```
┌─────────────┐       ┌──────────────┐
│ Email-сервер│◄──────┤ Обработчик   │◄─────┐
└─────────────┘       │ Email        │      │
                      └──────────────┘      │
                            │               │
                            ▼               │
┌─────────────┐       ┌──────────────┐      │
│   Telegram  │◄──────┤ Обработчик   │      │
│    Сервер   │       │ Telegram     │      │
└─────────────┘       └──────────────┘      │
                              ▲             │
                              │             │
                              ▼             │
                      ┌───────────────┐     │
                      │  Системный    │     │
                      │ Контроллер    │     │
                      └───────────────┘     │
                              ▲             │   
                              │             │
                              ▼             │
                      ┌───────────────┐     │
                      │   Менеджер    │◄────┘
                      │ Базы данных   │
                      └───────────────┘
                              ▲
                              │
                              ▼
                      ┌───────────────┐
                      │    SQLite     │
                      │ База данных   │
                      └───────────────┘
                              ▲
                              │
               ┌──────────────┴───────────┐
               │                          │
        ┌─────────────┐         ┌───────────┐
        │  Интерфейс  │         │CLI-инструмент│
        │администратора│        └───────────┘
        └─────────────┘          
```

### Поток процессов
1. Системный контроллер инициализирует и координирует все компоненты
2. Обработчик электронной почты опрашивает почтовый сервер через регулярные интервалы
3. Когда письмо соответствует настроенным фильтрам, оно обрабатывается и пересылается
4. Обработчик Telegram доставляет сообщение соответствующим пользователям
5. Менеджер базы данных поддерживает темы пользователей и состояние системы
6. Интерфейс администратора и CLI-инструмент предоставляют возможности управления

## 3. Установка и настройка

### Предварительные требования
- Python 3.13 или новее
- pip (менеджер пакетов Python)
- Доступ к IMAP-аккаунту электронной почты
- Токен Telegram-бота (полученный от BotFather)

### Шаги установки

1. **Клонирование или скачивание репозитория**

2. **Установка зависимостей**
   ```bash
   pip install -r requirements.txt
   ```

3. **Создание файла конфигурации**
   Создайте файл `.env` в корне проекта со следующими параметрами:
   ```
   # Database settings
    DATABASE_PATH=data/email_bot.db # Можно оставить как есть
    
    # Email settings
    EMAIL_ACCOUNT=example@yandex.ru # Почта на которой будут проверяться письма
    EMAIL_PASSWORD=imap-pass # Пароль не от самой почты, а от imap доступа к этой почте
    
    # Telegram settings
    TELEGRAM_TOKEN=your-telegram-bot-token # токен бота
    
    # Web admin settings
    ADMIN_USERNAME=log-admin # логин для входа в админку
    ADMIN_PASSWORD=log-pass # пароль для входа в админку 
    SECRET_KEY=random-secret-key # secret key
    
    # System settings
    LOG_LEVEL=INFO # Можно также выбрать ERROR, WARNING, DEBUG
    CHECK_INTERVAL=5 # Интервал проверки почты, тестировался на 5 мин.
   ```

4. **Инициализация базы данных**
   ```bash
   python -m run_tools system optimize --repair-db
   ```

5. **Запуск системы**
   ```bash
   python -m run_tools system start
   ```

### Параметры конфигурации

#### Основные переменные окружения
- `EMAIL_ACCOUNT` - Аккаунт электронной почты для мониторинга
- `EMAIL_PASSWORD` - Пароль для аккаунта электронной почты
- `TELEGRAM_TOKEN` - Токен Telegram-бота от BotFather
- `ADMIN_PASSWORD` - Пароль для веб-интерфейса администратора

#### Дополнительная настройка
- `EMAIL_SERVER` - Адрес IMAP-сервера (по умолчанию: imap.yandex.ru)
- `CHECK_INTERVAL` - Интервал проверки почты в минутах (по умолчанию: 5)
- `ADMIN_USERNAME` - Имя пользователя для административного интерфейса (по умолчанию: admin)
- `SECRET_KEY` - Секретный ключ Flask для безопасности сессий
- `DATABASE_PATH` - Путь к базе данных SQLite (по умолчанию: data/email_bot.db)
- `LOG_LEVEL` - Уровень ведения журнала (по умолчанию: INFO)

## 4. Структура базы данных

Система использует SQLite с режимом Write-Ahead Logging (WAL) для оптимальной производительности. Схема базы данных состоит из следующих основных таблиц:

### Таблицы

#### Таблица `users`
Хранит информацию о зарегистрированных пользователях.

| Столбец    | Тип       | Описание                                |
|------------|-----------|----------------------------------------|
| chat_id    | TEXT      | ID чата Telegram (первичный ключ)       |
| status     | TEXT      | Статус пользователя (Enable/Disable)    |
| created_at | TIMESTAMP | Временная метка создания пользователя   |
| updated_at | TIMESTAMP | Временная метка последнего обновления   |

#### Таблица `subjects`
Хранит фильтры тем писем для каждого пользователя.

| Столбец    | Тип       | Описание                                   |
|------------|-----------|-------------------------------------------|
| id         | INTEGER   | Автоинкрементный ID (первичный ключ)       |
| chat_id    | TEXT      | Внешний ключ к users.chat_id               |
| subject    | TEXT      | Шаблон фильтра темы письма                 |
| created_at | TIMESTAMP | Временная метка создания фильтра           |

### Связи
- Связь один-ко-многим между `users` и `subjects`
- Ограничение внешнего ключа: `subjects.chat_id` ссылается на `users.chat_id` с каскадным удалением

### Оптимизация базы данных
- Использует режим WAL для параллельного доступа
- Поддерживает индексы на часто запрашиваемых столбцах
- Реализует пул соединений для эффективного доступа

## 5. Модули и компоненты

### Системный контроллер (`system.py`)
Центральный модуль, который координирует и мониторит все компоненты системы.

**Основные обязанности:**
- Инициализация системы и координация компонентов
- Фоновый мониторинг состояния системы
- Управление процессами и восстановление после сбоев
- Отчетность о состоянии и диагностика

**Классы:**
- `EmailTelegramSystem`: Основной класс системы с методами для запуска/остановки компонентов

### Обработчик электронной почты (`email_handler.py`)
Отвечает за мониторинг, фильтрацию и обработку электронной почты.

**Основные обязанности:**
- Подключение к IMAP-серверу и опрос
- Фильтрация писем на основе темы
- Извлечение и форматирование содержимого писем
- Обработка вложений

**Классы:**
- `EmailTelegramForwarder`: Управляет логикой мониторинга и пересылки писем

### Обработчик Telegram (`telegram_handler.py`)
Управляет Telegram-ботом и доставкой сообщений.

**Основные обязанности:**
- Инициализация бота и регистрация команд
- Взаимодействие с пользователем и обработка команд
- Форматирование и доставка сообщений
- Управление статусом пользователя

**Классы:**
- `EmailBotHandler`: Обрабатывает работу Telegram-бота и обработку команд

### Менеджер базы данных (`manager.py`)
Предоставляет унифицированный интерфейс для операций с базой данных.

**Основные обязанности:**
- Пул соединений и управление транзакциями
- Методы доступа к данным пользователей и тем
- Кэширование запросов и оптимизация
- Обработка ошибок базы данных

**Классы:**
- `DatabaseManager`: Класс-синглтон для доступа к базе данных с кэшированием

### Интерфейс администратора (`admin.py`)
Веб-интерфейс администрирования, построенный на Flask.

**Основные обязанности:**
- Управление пользователями и темами
- Мониторинг состояния системы
- SQL-консоль для прямого доступа к базе данных
- Аутентификация и безопасность

**Маршруты:**
- `/login` - Страница входа
- `/` - Панель управления
- `/users` - Управление пользователями
- `/user/<chat_id>` - Детали пользователя
- `/sql-console` - SQL-консоль
- `/bot-status` - Статус и управление ботом

### CLI-инструмент (`tools.py`)
Интерфейс командной строки для управления системой.

**Основные обязанности:**
- Запуск/остановка системы
- Управление базой данных
- Администрирование пользователей/тем
- Диагностика и устранение неполадок

**Режимы:**
- `query` - Функциональность запросов к базе данных
- `admin` - Управление пользователями и темами
- `system` - Управление и диагностика системы
- `shell` - Интерактивная оболочка для управления

### Вспомогательные модули

#### Менеджер кэша (`cache_manager.py`)
Управляет инвалидацией кэша между процессами.

**Основные функции:**
- `invalidate_caches()`: Инвалидирует все кэши
- `is_cache_valid()`: Проверяет, действительны ли кэшированные данные

#### Логгер (`logger.py`)
Расширенное ведение журнала с ротацией и очисткой.

**Основные функции:**
- `get_logger()`: Создает или получает настроенный логгер
- `clean_old_logs()`: Автоматическая очистка старых лог-файлов

#### Статус бота (`bot_status.py`)
Отслеживает и управляет рабочим состоянием бота.

**Основные функции:**
- `get_bot_status()`: Получает текущий статус бота
- `start_bot()`: Запускает бота
- `stop_bot()`: Останавливает бота

## 6. API и точки интеграции

### Внутренние API

#### API менеджера базы данных
```python
# Инициализация менеджера базы данных
db_manager = DatabaseManager()

# Управление пользователями
db_manager.add_user(chat_id, status)
db_manager.update_user_status(chat_id, enabled)
db_manager.delete_user(chat_id)

# Управление темами
db_manager.add_subject(chat_id, subject)
db_manager.add_multiple_subjects(chat_id, subjects_list)
db_manager.delete_subject(chat_id, subject)
db_manager.delete_all_user_subjects(chat_id)

# Получение данных
db_manager.get_user_status(chat_id)
db_manager.get_user_subjects(chat_id)
db_manager.get_all_users()
db_manager.get_all_client_data()
db_manager.get_active_users_with_subjects()
```

#### API обработчика электронной почты
```python
# Инициализация форвардера
forwarder = EmailTelegramForwarder(db_manager)

# Тестирование соединений
connection_status = forwarder.test_connections()

# Запуск мониторинга почты
forwarder.start_scheduler(interval=5)  # интервал 5 минут

# Ручная обработка писем
forwarder.process_emails()

# Завершение работы форвардера
forwarder.shutdown()
```

#### API обработчика Telegram
```python
# Инициализация обработчика бота
bot_handler = EmailBotHandler(db_manager)

# Запуск бота
bot_handler.start()

# Проверка, работает ли бот
is_running = bot_handler.is_alive()

# Перезапуск бота
bot_handler.restart()

# Остановка бота
bot_handler.stop()
```

### Внешние точки интеграции

#### Интеграция с электронной почтой
Система интегрируется с IMAP-серверами электронной почты, преимущественно настроена для Яндекс.Почты.

**Параметры подключения:**
- Адрес IMAP-сервера (по умолчанию: imap.yandex.ru)
- Учетные данные электронной почты
- Таймаут соединения и настройки повторных попыток

#### Интеграция с Telegram
Интегрируется с Telegram Bot API, используя библиотеку pyTelegramBotAPI.

**Возможности:**
- Обработка команд
- Разметка клавиатуры для взаимодействия с пользователем
- Форматирование сообщений с поддержкой Markdown
- Обработка файловых и графических вложений

## 7. Интерфейс администратора

Веб-интерфейс администратора предоставляет комплексный инструментарий для управления системой.

### Основные возможности
- **Панель управления**: Обзор состояния системы и быстрые действия
- **Управление пользователями**: Добавление, редактирование и удаление пользователей
- **Управление темами**: Настройка фильтров тем электронной почты для пользователей
- **Управление ботом**: Запуск, остановка и мониторинг бота
- **SQL-консоль**: Прямой доступ к базе данных с сохраненными запросами
- **Системная диагностика**: Мониторинг производительности и устранение неполадок

### Функции безопасности
- Защита от CSRF
- Управление сессиями и таймауты
- Защита от перебора с прогрессивными блокировками
- Предотвращение SQL-инъекций
- Безопасная аутентификация с хешированием паролей

### Руководство по использованию

1. **Вход**
   Доступ к интерфейсу администратора по адресу `http://your-server:5000/` и вход с учетными данными администратора.

2. **Панель управления**
   Просмотр состояния системы, количества активных пользователей и кнопки быстрых действий.

3. **Управление пользователями**
   - Просмотр всех пользователей и их статусов
   - Добавление новых пользователей по ID чата Telegram
   - Включение/отключение уведомлений для пользователей
   - Удаление пользователей и их подписок

4. **Управление темами**
   - Просмотр и редактирование фильтров тем для пользователей
   - Добавление новых фильтров тем
   - Массовый импорт тем из текста
   - Обнаружение дублирующихся тем среди пользователей

5. **Управление ботом**
   - Запуск/остановка бота
   - Просмотр времени работы и статуса бота
   - Мониторинг производительности бота

6. **SQL-консоль**
   - Выполнение пользовательских SQL-запросов
   - Использование предопределенных шаблонов запросов
   - Просмотр структуры и данных таблиц
   - Экспорт результатов запросов

## 8. Использование CLI

Инструмент командной строки (CLI) предоставляет комплексные возможности управления системой.

### Базовый синтаксис
```bash
python -m run_tools [режим] [команда] [аргументы]
```

### Доступные режимы

#### Режим запросов (query)
Для запросов к базе данных и её исследования.

```bash
# Выполнение SQL-запроса
python -m run_tools query --sql "SELECT * FROM users"

# Показать все таблицы
python -m run_tools query tables

# Запустить предопределенный запрос
python -m run_tools query common "All users"
```

#### Режим администрирования (admin)
Для управления пользователями и темами.

```bash
# Список всех пользователей
python -m run_tools admin list-users

# Добавить нового пользователя
python -m run_tools admin add-user 123456789 --status Enable

# Изменить статус пользователя
python -m run_tools admin set-status 123456789 Disable

# Список тем пользователя
python -m run_tools admin list-subjects 123456789

# Добавить тему
python -m run_tools admin add-subject 123456789 "Важный отчет"

# Удалить тему
python -m run_tools admin delete-subject 42  # по ID
python -m run_tools admin delete-subject-by-name 123456789 "Старая тема"
```

#### Режим системы (system)
Для управления и диагностики системы.

```bash
# Запуск системы
python -m run_tools system start

# Проверка статуса системы
python -m run_tools system status
python -m run_tools system status --detailed

# Перезапуск компонентов
python -m run_tools system restart-bot

# Проверка соединений
python -m run_tools system check-connections

# Просмотр недавних ошибок
python -m run_tools system errors --count 5

# Оптимизация системы
python -m run_tools system optimize --clear-logs --optimize-db

# Интерактивная оболочка
python -m run_tools system shell
```

#### Интерактивная оболочка
Наиболее гибкий способ управления системой.

```bash
python -m run_tools system shell
```

Доступные команды оболочки:
- `start`, `stop`, `restart` - Управление всей системой
- `start-web`, `start-bot`, `stop-web`, `stop-bot` - Управление отдельными компонентами
- `status`, `detail` - Проверка статуса системы
- `users`, `subjects [chat_id]` - Просмотр пользователей и тем
- `add-user`, `set-status`, `delete-user` - Управление пользователями
- `add-subject`, `delete-subject` - Управление темами
- `sql [query]` - Выполнение SQL-запросов
- `check` - Проверка соединений
- `optimize` - Выполнение оптимизации системы
- `errors` - Просмотр недавних ошибок

## 9. Обработка ошибок и ведение журнала

Система реализует комплексные механизмы обработки ошибок и ведения журнала.

### Система ведения журнала

#### Настройка логгера
- Ротация журналов с ограничениями размера (по умолчанию: 5МБ на файл)
- Автоматическая очистка старых журналов (по умолчанию: хранение 30 дней)
- Настраиваемые уровни журналирования (INFO, DEBUG, WARNING, ERROR)
- Отдельные файлы журналов для разных компонентов

#### Расположение файлов журнала
- Основная директория журналов: `/logs/`
- Журналы для конкретных компонентов: например, `email_bot_20230101.log`, `web_admin_20230101.log`

#### Доступ к журналам
- Через CLI: `python -m src.tools system errors`
- Напрямую из файлов в директории `/logs/`
- Через интеграцию с syslog (если настроено)

### Стратегия обработки ошибок

#### Многоуровневая обработка ошибок
1. **Уровень компонентов**: Каждый компонент обрабатывает свои специфические ошибки
2. **Уровень системы**: Системный контроллер отслеживает и восстанавливает компоненты после сбоев
3. **Уровень процессов**: Обработчики сигналов обеспечивают чистое завершение при системных сигналах

#### Распространенные сценарии ошибок

**Сбои соединения с электронной почтой**
- Автоматические повторные попытки с экспоненциальной задержкой
- Управление и обновление пула соединений
- Подробное журналирование ошибок IMAP

**Проблемы с Telegram API**
- Очередь сообщений с устойчивым повторением
- Защита от превышения лимитов
- Изящная деградация при частичных сбоях

**Ошибки базы данных**
- Откат транзакций при сбое
- Управление пулом соединений
- Режим WAL для повышенной надежности
- Автоматические механизмы восстановления

**Сбои процессов**
- Мониторинг сторожевым таймером
- Автоматический перезапуск компонентов
- Сохранение состояния, где возможно
- Обновления статусных файлов для мониторинга

## 10. Вопросы безопасности

Система включает несколько мер безопасности для защиты данных и предотвращения несанкционированного доступа.

### Аутентификация и авторизация

**Интерфейс администратора**
- Аутентификация по имени пользователя/паролю
- Защита CSRF на всех формах
- Управление сессиями с таймаутами
- Защита от перебора с прогрессивными таймаутами

**Telegram-бот**
- Верификация chat_id для команд
- Ограничение скорости выполнения команд
- Контроль доступа для административных функций

### Защита данных

**Учетные данные**
- Переменные окружения для чувствительных данных
- Отсутствие жестко закодированных секретов в коде
- Возможность использования отдельного файла .env

**База данных**
- SQLite с соответствующими правами доступа
- Параметризованные запросы для предотвращения SQL-инъекций
- Изоляция транзакций для обеспечения согласованности данных

**Сеть**
- Поддержка HTTPS в веб-интерфейсе
- Безопасные соединения с IMAP и Telegram
- Поддержка прокси для ограниченных сред

### Операционная безопасность

**Сообщения об ошибках**
- Санитизированные сообщения об ошибках для пользователей
- Детальное внутреннее журналирование без чувствительных данных
- Специальные страницы ошибок для продакшн-среды

**Защита ресурсов**
- Ограничение скорости для конечных точек API
- Пул соединений для предотвращения истощения ресурсов
- Обработка таймаутов для внешних сервисов

**Изоляция процессов**
- Разделение компонентов на различные процессы
- Контролируемое завершение процессов и очистка
- Ограничения ресурсов и мониторинг

## 11. Устранение неполадок

### Распространенные проблемы и решения

#### Система не запускается

**Проверьте, не запущены ли уже процессы**
```bash
python -m run_tools system status
```

**Проверьте конфликты портов**
```bash
netstat -tuln | grep 5000
```

**Проверьте доступ к базе данных**
```bash
python -m run_tools system optimize --repair-db
```

**Проверьте журналы на наличие ошибок**
```bash
python -m run_tools system errors
```

#### Пересылка электронной почты не работает

**Проверьте учетные данные электронной почты**
```bash
python -m run_tools system check-connections
```

**Проверьте статус бота**
```bash
python -m run_tools system status --detailed
```

**Убедитесь, что у пользователя настроены темы**
```bash
python -m run_tools admin list-subjects <chat_id>
```

**Подтвердите, что статус пользователя включен**
```bash
python -m run_tools admin list-users | grep <chat_id>
```

#### Проблемы с веб-интерфейсом администратора

**Проверьте, запущен ли интерфейс**
```bash
python -m run_tools system status
```

**Перезапустите веб-интерфейс**
```bash
python -m run_tools system restart-web
```

**Проверьте журналы ошибок**
```bash
tail -n 100 logs/web_admin_*.log
```

**Сбросьте пароль администратора**
Отредактируйте файл `.env`, чтобы обновить значение ADMIN_PASSWORD.

#### Повреждение базы данных

**Запустите восстановление базы данных**
```bash
python -m run_tools system optimize --repair-db
```

**Проверьте целостность базы данных**
```bash
python -m run_tools query --sql "PRAGMA integrity_check;"
```

**Восстановите из резервной копии** (если доступно)
```bash
cp backup_*.db data/email_bot.db
```

### Диагностические команды

**Проверка статуса системы**
```bash
python -m run_tools system status --detailed
```

**Тестирование соединений**
```bash
python -m run_tools system check-connections
```

**Просмотр недавних ошибок**
```bash
python -m run_tools system errors --count 20
```

**Статистика базы данных**
```bash
python -m run_tools query --sql "SELECT COUNT(*) FROM users;"
python -m run_tools query --sql "SELECT COUNT(*) FROM subjects;"
```

**Информация о процессах**
```bash
python -m run_tools system shell
> debug
```

## 12. FAQ

### Общие вопросы

**В: Какие почтовые провайдеры поддерживаются?**
О: Любой провайдер электронной почты с поддержкой IMAP. Система предварительно настроена для Яндекс.Почты, но может быть настроена для Gmail, Outlook или других IMAP-сервисов.

**В: Как часто проверяются письма?**
О: По умолчанию, каждые 5 минут. Это можно настроить с помощью параметра CHECK_INTERVAL в файле .env.

**В: Можно ли отслеживать несколько почтовых аккаунтов?**
О: Текущая архитектура поддерживает один почтовый аккаунт. Для нескольких аккаунтов вам потребуется запустить отдельные экземпляры системы.

**В: Как обрабатываются вложения?**
О: Вложения писем пересылаются в Telegram с ограничениями по размеру (до 50МБ). Изображения отправляются как фотографии, другие файлы - как документы.

### Технические вопросы

**В: Как выполняется резервное копирование базы данных?**
О: Система не включает автоматическое резервное копирование. Используйте CLI для создания ручных резервных копий:
```bash
python -m run_tools admin backup-db backup_filename.db
```

**В: Что происходит, если бот падает?**
О: Системный контроллер отслеживает все компоненты и автоматически перезапускает их в случае сбоя. Дополнительно, для производственных сред может быть реализован процесс сторожевого таймера.

**В: Как я могу расширить функциональность системы?**
О: Модульная архитектура позволяет легко расширять функциональность. Большинство компонентов имеют четкие интерфейсы, которые можно расширить или заменить.

**В: Можно ли запустить систему как службу?**
О: Да, вы можете использовать systemd (Linux), Службы Windows или инструменты вроде Supervisor для запуска системы как службы.

### Вопросы производительности

**В: Сколько пользователей может поддерживать система?**
О: Производительность зависит от оборудования, но база данных SQLite с режимом WAL и пулом соединений эффективна для большинства случаев использования.

**В: Каковы требования к ресурсам?**
О: Минимальные. Система может работать на недорогих VPS с 512МБ ОЗУ и 1 ядром ЦП для умеренных нагрузок (сотни пользователей, тысячи тем).

**В: Как работает кэширование?**
О: Система реализует несколько уровней кэширования:
1. Кэширование запросов к базе данных
2. Кэширование данных в памяти с ограниченным временем жизни
3. Инвалидация кэша между процессами для согласованности

**В: Может ли система масштабироваться горизонтально?**
О: Текущая архитектура разработана для вертикального масштабирования. Горизонтальное масштабирование потребует модификаций для использования распределенной базы данных и очереди сообщений.

### Вопросы о Telegram-боте

**В: Какие команды поддерживает бот?**
О: Бот поддерживает следующие команды:
- `/start` - Запуск бота и получение приветственного сообщения
- `/status` - Проверка текущего статуса и тем
- `/reports` - Список ваших подписанных тем
- `/enable` - Включение уведомлений
- `/disable` - Отключение уведомлений
- `/help` - Показать справочное сообщение

**В: Как пользователи подписываются на темы?**
О: Пользователи не могут напрямую подписываться на темы через бота. Администратор должен добавлять темы для пользователей через веб-интерфейс или CLI.

**В: Может ли бот отправлять сообщения в групповые чаты?**
О: Да, бот может отправлять сообщения в групповые чаты, если бот был добавлен в группу. Используйте ID чата группы в управлении пользователями.

## 13. Расширенная настройка

### Настройка управления процессами

Для продакшн-развертываний рекомендуется использовать менеджер процессов:

#### Пример службы Systemd
```ini
[Unit]
Description=Система пересылки Email в Telegram
After=network.target

[Service]
User=youruser
WorkingDirectory=/path/to/project
ExecStart=/usr/bin/python -m src.tools system start
Restart=always
RestartSec=10
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
```

#### Пример конфигурации Supervisor
```ini
[program:email-telegram-bot]
command=python -m src.tools system start
directory=/path/to/project
user=youruser
autostart=true
autorestart=true
stderr_logfile=/var/log/email-telegram-bot.err.log
stdout_logfile=/var/log/email-telegram-bot.out.log
environment=PYTHONUNBUFFERED=1
```

### Настройка производительности

#### Производительность базы данных
Отрегулируйте следующие параметры в соединении с базой данных:
- `cache_size`: Увеличьте для лучшей производительности с большими наборами данных
- `mmap_size`: Настройте в зависимости от доступной памяти
- `busy_timeout`: Увеличьте в сценариях с высокой конкурентностью

#### Управление памятью
Система использует пул соединений и кэширование объектов для уменьшения использования памяти. Вы можете настроить:
- Размер пула соединений в `manager.py`
- TTL кэша в различных компонентах
- Размер пула потоков для параллельных операций

#### Настройка журналирования
Для производственных сред настройте уровни журналирования:
```
LOG_LEVEL=WARNING  # Показывать только предупреждения и ошибки
```

Для уменьшения использования диска настройте параметры ротации журналов в `logger.py`:
- `max_size_mb`: Максимальный размер файла журнала
- `backup_count`: Количество резервных файлов для хранения

## 14. Разработка и расширение

### Настройка среды разработки

1. **Клонировать репозиторий**
   ```bash
   git clone [url-репозитория]
   cd email-telegram-forwarder
   ```

2. **Создать виртуальное окружение**
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```

3. **Установить зависимости для разработки**
   ```bash
   pip install -r requirements-dev.txt
   ```

### Структура проекта
```
Telegram_Mail-Bot/
├── data/                         # Data files directory
├── docs/                         # Documentation
├── logs/                         # Log files directory
├── scripts/                      # Scripts directory
├── src/                          # Source code
│   ├── cli/                      # Command line interface components
│   │   ├── __init__.py
│   │   └── tools.py
│   ├── config/                   # Configuration files
│   │   ├── __init__.py
│   │   └── settings.py
│   ├── core/                     # Core functionality
│   │   ├── __init__.py
│   │   ├── bot_status.py
│   │   ├── email_handler.py
│   │   ├── system.py
│   │   └── telegram_handler.py
│   ├── db/                       # Database operations
│   │   ├── __init__.py
│   │   ├── manager.py
│   │   └── tools.py
│   ├── utils/                    # Utility functions
│   │   ├── __init__.py
│   │   ├── cache_manager.py
│   │   └── logger.py
│   └── web/                      # Web interface
│       ├── static/               # Static assets
│       │   ├── css/
│       │   ├── img/
│       │   ├── js/
│       │   └── manifest.webmanifest
│       ├── templates/            # HTML templates
│       │   ├── includes/
│       │   │   ├── header.html
│       │   │   └── sidebar.html
│       │   ├── 404.html
│       │   ├── 500.html
│       │   ├── add_user.html
│       │   ├── base.html
│       │   ├── bot_status.html
│       │   ├── confirm_bulk_subjects.html
│       │   ├── confirm_duplicate_subject.html
│       │   ├── confirm_edit_subject.html
│       │   ├── help.html
│       │   ├── index.html
│       │   ├── login.html
│       │   ├── sql_console.html
│       │   ├── user_details.html
│       │   └── users.html
│       ├── __init__.py
│       └── admin.py
├── .env                          # Environment variables
├── .gitignore                    # Git ignore file
├── LICENSE                       # License file
├── README.md                     # Project documentation
├── requirements.txt              # Python dependencies
└── run_tools.py                  # Tool runner script
```

### Расширение системы

#### Добавление новых функций
Для расширения системы новыми функциями:

1. **Определите соответствующий компонент** для модификации
2. **Добавьте вашу функциональность**, следуя существующим паттернам
3. **Обновите схему базы данных**, если необходимо
4. **Добавьте соответствующие конечные точки API** или CLI-команды
5. **Обновите документацию**, чтобы отразить изменения

#### Пример: Добавление фильтрации писем по отправителю

1. Модифицируйте `email_handler.py` для поддержки фильтрации по отправителю:
   ```python
   def check_sender_match(self, email_sender: str) -> List[Tuple[str, str]]:
       # Аналогично check_subject_match, но для отправителей
       matching_senders = []
       email_sender_lower = email_sender.lower()
       
       # Детали реализации...
       
       return matching_senders
   ```

2. Обновите схему базы данных:
   ```sql
   -- Добавление новой таблицы для фильтров отправителей
   CREATE TABLE senders (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       chat_id TEXT NOT NULL,
       sender TEXT NOT NULL,
       created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
       FOREIGN KEY (chat_id) REFERENCES users (chat_id) ON DELETE CASCADE,
       UNIQUE(chat_id, sender)
   );
   ```

3. Добавьте методы в `DatabaseManager` для управления отправителями

4. Обновите интерфейс администратора и CLI для управления фильтрами отправителей

#### Пример: Добавление перевода сообщений

1. Добавьте новый вспомогательный модуль для перевода:
   ```python
   # src/utils/translator.py
   
   def translate_text(text: str, target_language: str) -> str:
       # Реализация с использованием API перевода
       pass
   ```

2. Модифицируйте `email_handler.py` для использования перевода:
   ```python
   from src.utils.translator import translate_text
   
   # В методе send_to_telegram:
   if user_preferences.get('translate_to'):
       body = translate_text(body, user_preferences['translate_to'])
   ```

3. Обновите схему предпочтений пользователя и интерфейсы управления
